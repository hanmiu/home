<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1" />
<!--
<meta property="og:url" content="https://www.hanmiu.cc/play/toy/ctr.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="‚óè ‚ñ≤ ‚ñ†" />
<meta property="og:description" content="" />
<meta property="og:image" content="https://www.hanmiu.cc/images/logotype/preview.jpg" />
-->
<title>‚óè ‚ñ≤ ‚ñ†</title>
<!--
<link rel="icon" type="image/png" href="./images/logotype/favicon.png">
-->
<style>
  body {
    margin: 0;
    overflow: hidden;
  }
  
  .ui {
    display: flex;
    position: fixed;
    box-sizing: border-box;
    width: 100%;
    height: 50px;
    justify-content: center;
    user-select: none;
  }
  
  #ui-up {
    left: 0px;
    top: 0px;
    background-color: aquamarine;
  }
  
  #ui-down {
    left: 0px;
    bottom: -50px;
    background-color: aquamarine;
    transition: bottom 0.5s ease-in-out;
  }
  
  .bt {
    display: inline-flex;
    width: 50px;
    height: 50px;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  
  .canvas {
    position: fixed;
    left: 0px;
    top: 0px;
  }
</style>
<body>
  <canvas class="canvas" id="canvas"></canvas>
  <canvas class="canvas" id="front"></canvas>
  <div class="ui" id="ui-up">
    <div class="bt" id="camera">üì∑</div>
    <div class="bt" id="circle">‚óè</div>
    <div class="bt" id="triangle">‚ñ≤</div>
    <div class="bt" id="rectangle">‚ñ†</div>
    <div class="bt" id="pen">üñçÔ∏è</div>
    <div class="bt">üíæ</div>
  </div>
  <div class="ui" id="ui-down">
    <div class="bt" id="take-photo">‚óé</div>
  </div>
</body>
<script>
  let g = document.querySelector('#canvas').getContext('2d');
  let g_front = document.querySelector('#front').getContext('2d');
  let g_mask = document.createElement('canvas').getContext('2d');
  
  let el_ui_down = document.querySelector('#ui-down');
  let bt_camera = document.querySelector('#camera');
  let bt_take_photo = document.querySelector('#take-photo');
  
  let el_video = document.createElement('video');
  el_video.autoplay = true;
  el_video.playsInline = true;
  let video_stream = null;
  
  function connect_video() {
    let constraints = {
      audio: false,
      video: { facingMode: 'environment' }
    };
    
    navigator.mediaDevices.getUserMedia(constraints)
    .then(function(stream) {
      el_video.srcObject = stream;
      video_stream = stream;
      el_video.onloadedmetadata = function(e) {
        el_video.play();
      };
    })
    .catch(function(err) {
      /* handle the error */
      console.log(err.name + ": " + err.message);
    });
  }
  
  function stop_video() {
    if(video_stream) {
      video_stream.getTracks().forEach(track => track.stop())  
    }
  }
  
  function touchstart(e) {
    /*
    let eX, eY;
    if(e.targetTouches) {
      eX = e.targetTouches[0].pageX;
      eY = e.targetTouches[0].pageY;
	}
    else {
      eX = e.pageX;
      eY = e.pageY;
    }
    touchX = eX;
    touchY = eY;
    
    mdown = true;
    for(let i = 0; i < jamos.length; i++) {
      let jamo = jamos[i];
      let dx = eX - jamo.x;
      let dy = eY - jamo.y;
      let d = Math.sqrt(dx*dx + dy*dy) + 1e-6;
      if(d < jamo.r) {
        selected_jamo = jamo;
        jamo.vx = 0;
        jamo.vy = 0;
        jamo.to_hue = Math.random() < 0.2 ? Math.random() * 30 | 0 : 100 + Math.random() * 260 | 0;
      }
    }
    */
  }
  
  function touchmove(e) {
    let eX, eY;
    if(e.targetTouches) {
      e.preventDefault();
      eX = e.targetTouches[0].pageX;
      eY = e.targetTouches[0].pageY;
	}
    else {
      eX = e.pageX;
      eY = e.pageY;
    }
    /*
    touchX = eX;
    touchY = eY;
    
    if(selected_jamo && mdown) {
      selected_jamo.x = eX;
      selected_jamo.y = eY;
    }
    */
  }
  
  function touchend(e) {
    //mdown = false;
    //selected_jamo = null;
  }
  
  function layout() {
    g.canvas.width = innerWidth;
    g.canvas.height = innerHeight;
    g_front.canvas.width = innerWidth;
    g_front.canvas.height = innerHeight;
    g_mask.canvas.width = innerWidth;
    g_mask.canvas.height = innerHeight;
    document.querySelector('#ui-down').style.bottom = '-50px';
  }
  
  function draw_front(g) {
    g.clearRect(0, 0, g.canvas.width, g.canvas.height);
    
    g.globalCompositeOperation = 'source-over';
    
    g.save();
    g.translate(innerWidth/2, innerHeight/2);
    g.translate(-el_video.videoWidth/2, -el_video.videoHeight/2);
    g.drawImage(el_video, 0, 0, el_video.videoWidth, el_video.videoHeight);
    g.restore();
  
    g.globalCompositeOperation = 'multiply';
    g.drawImage(g_mask.canvas, 0, 0);
  }
  
  function draw_mask(g) {
    g.clearRect(0, 0, g.canvas.width, g.canvas.height);
  
    g.fillStyle = 'black';
    g.fillRect(0, 0, g.canvas.width, g.canvas.height);
    g.save();
    g.translate(innerWidth/2, innerHeight/2);
    g.beginPath();
    g.arc(0, 0, 100, 0, Math.PI * 2);
    g.fillStyle = 'white';
    g.fill();
    g.restore();
  }
  
  function draw() {
    draw_mask(g_mask);
    draw_front(g_front);
  }
  
  function loop() {
    draw();
    requestAnimationFrame(loop);
  }
  
  function init() {
    layout();
    loop();
  }
  
  bt_camera.addEventListener('click', (E) => {
    connect_video();
    el_ui_down.style.bottom = '0px';
  });
  
  bt_take_photo.addEventListener('click', (E) => {
    el_ui_down.style.bottom = '-50px';
    stop_video();
  });
  
  g.canvas.addEventListener('mousedown', touchstart);
  g.canvas.addEventListener('mouseup', touchend); 
  g.canvas.addEventListener('mousemove', touchmove);
  
  g.canvas.addEventListener('touchstart', touchstart);
  g.canvas.addEventListener('touchend', touchend);
  g.canvas.addEventListener('touchmove', touchmove);
  
  window.addEventListener('resize', layout);
  
  window.addEventListener("orientationchange", function(e) {
    setTimeout(() => {
      layout();
    }, 100);
  });
  
  init();
</script>