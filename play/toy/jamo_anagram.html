<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
<title>자모 어구전철(애너그램)</title>
<style>
    body {
        overflow: hidden;
    }

    #answer {
        color: rgba(0, 0, 0, 1.0);
        transition: color 0.5s;
    }

    #stage {
        position: absolute;
        left: 0px;
        top: 0px;
    }

    .jamo {
        position: absolute;
        width: 10px;
        height: 10px;
        font-size: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        /* border: 1px solid rgba(0, 0, 0, 0.25); */
        user-select: none;
        cursor: pointer;
    }

    .jamo:hover {
        /* text-shadow: 0px 0px 10px rgba(255, 255, 0, 1); */
        -webkit-text-stroke: 3px blue;
        color: blue;
    }

    #ui-top {
        position: absolute;
        left: 20px;
        top: 20px;
    }

    #ui-bottom {
        position: absolute;
        right: 20px;
        bottom: 20px;
        text-align: right;
    }
</style>
<body>
    <div id="stage">
        <!--<div class="jamo" style="left: 200px; top: 300px">ㅎ</div>-->
    </div>
    <div id="ui-top">
        <input type="checkbox" id="show-answer" checked>
        <input type="text" id="answer" spellcheck="false" autocomplete="off" value="한미">
        <button id="quiz">문제 만들기</button>
        <button id="reset">다시 시작</button>
    </div>
    <div id="ui-bottom">
        <input type="text" id="test" spellcheck="false" autocomplete="off" value="">
    </div>
</body>
<script>
    let params = new URLSearchParams(new URL(location.href).search);
    if(params.has('answer')) {
        document.querySelector('#show-answer').checked = false;
        document.querySelector('#answer').style.color = 'rgba(0, 0, 0, 0.0)';
        document.querySelector('#answer').value = params.get('answer');
    }
    let jamo_size = 100;

    function shuffle(array) {
        let n = array.length, t, i;
        while (n) {
            i = Math.random() * n-- | 0; // 0 ≤ i < n
            t = array[n];
            array[n] = array[i];
            array[i] = t;
        }
        return array;
    }

    document.querySelector('#quiz').addEventListener('click', () => {
        clear();
        let answer = document.querySelector('#answer');
        let chars = answer.value.split('');
        console.log(chars);
        let jamos = [];
        for(let ch of chars) {
            let decomposed = Array.from(ch.normalize('NFD'));
            console.log(ch, decomposed);
            jamos.push(...decomposed);
        }
        let shuffled = shuffle(jamos);
        console.log(shuffled);
        let x = jamo_size, y = 200;
        for(let jm of shuffled) {
            let jamo = document.createElement('div');
            jamo.dataset.jamo = jm;
            jamo.classList.add('jamo');
            jamo.innerText = jm;
            document.querySelector('#stage').appendChild(jamo);
            jamo.style.transform = `translate(${x}px, ${y}px)`;
            if(x + jamo_size > window.innerWidth) {
                y += jamo_size;
                x = jamo_size;
            }
            else {
                x += jamo_size;
            }
        }
    });

    function clear() {
        let stage = document.querySelector('#stage');
        stage.innerHTML = '';
        document.querySelector('#test').value = '';
    }

    document.querySelector('#reset').addEventListener('click', () => {
        document.querySelector('#answer').value = '';
        clear();
    });

    document.querySelector('#show-answer').addEventListener('change', (event) => {
        let answer = document.querySelector('#answer');
        if(event.target.checked) {
            answer.style.color = 'rgba(0, 0, 0, 1.0)';
        } else {
            answer.style.color = 'rgba(0, 0, 0, 0.0)';
        }
    });
    
    let selectedJamo = null;
    let offsetX = 0, offsetY = 0;

    function handleStart(event) {
        let target = event.target;
        if(target.classList.contains('jamo')) {
            selectedJamo = target;
            let rect = selectedJamo.getBoundingClientRect();

            if (event.type === 'mousedown') {
                offsetX = event.pageX - rect.left;
                offsetY = event.pageY - rect.top;
            } else if (event.type === 'touchstart') {
                offsetX = event.touches[0].pageX- rect.left;
                offsetY = event.touches[0].pageY - rect.top;
                selectedJamo.style['-webkit-text-stroke'] = '3px blue';
                selectedJamo.style.color = 'blue';
            }
        }
    }

    function handleMove(event) {
        if(selectedJamo) {
            let x, y;
            if (event.type === 'mousemove') {
                x = event.pageX - offsetX;
                y = event.pageY - offsetY;
            } else if (event.type === 'touchmove') {
                x = event.touches[0].pageX - offsetX;
                y = event.touches[0].pageY - offsetY;
                selectedJamo.style['-webkit-text-stroke'] = '3px blue';
                selectedJamo.style.color = 'blue';
            }
            selectedJamo.style.transform = `translate(${x}px, ${y}px)`;
            compose();
        }
    }

    function handleEnd(event) {
        if(selectedJamo) {
            selectedJamo.style['-webkit-text-stroke'] = '0px black';
            selectedJamo.style.color = 'black';
        }
        selectedJamo = null;
    }

    document.addEventListener('contextmenu', (event) => {
        event.preventDefault();
    });

    function resize() {
        // 가로가 세로보다 작으면 기존의 style rule에서 class가 jamo 인것의 font-size를 50px로 설정
        if(window.innerWidth < window.innerHeight) {
            jamo_size = 50;
            let styleSheet = document.styleSheets[0];
            let cssRules = Array.from(styleSheet.cssRules || styleSheet.rules);
            let rule = cssRules.filter(x => x.selectorText == '.jamo')[0];
            rule.style.fontSize = `${jamo_size}px`;
        }  
        else {
            jamo_size = 100;
        }     
    }

    document.addEventListener('resize', (event) => {
        resize();
    });

    document.addEventListener('mousedown', handleStart);
    document.addEventListener('touchstart', handleStart);

    document.addEventListener('mousemove', handleMove);
    document.addEventListener('touchmove', handleMove);

    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchend', handleEnd);

    function getJamoType(char) {
        const codePoint = char.codePointAt(0);

        // 초성 (Leading consonants): U+1100 – U+1112 (19자)
        // ᄀᄁᄂᄃᄄᄅᄆᄇᄈᄉᄊᄋᄌᄍᄎᄏᄐᄑᄒ
        if (codePoint >= 0x1100 && codePoint <= 0x1112) {
            return 0;
        }

        // 중성 (Vowels): U+1161 – U+1175 (21자)
        // ᅡᅢᅣᅤᅥᅦᅧᅨᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴᅵ
        if (codePoint >= 0x1161 && codePoint <= 0x1175) {
            return 1;
        }

        // 종성 (Trailing consonants): U+11A8 – U+11C2 (27자), U+11A7 (종성이 없는 경우)
        // ᆨᆩᆪᆫᆬᆭᆮᆯᆰᆱᆲᆳᆴᆵᆶᆷᆸᆹᆺᆻᆼᆽᆾᆿᇀᇁᇂ
        if ((codePoint >= 0x11A8 && codePoint <= 0x11C2) || codePoint === 0x11A7) {
            return 2;
        }

        // const syllable = 0xAC00 + (choIndex * 21 * 28) + (jungIndex * 28) + jongIndex;

        return -1;
    }

    function compose() {
        // ᅡᅢᅣᅤᅥᅦᅧᅨᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴᅵ
        let type_v = 'ᅡᅢᅣᅤᅥᅦᅧᅨᅵ'.split('');
        let type_h = 'ᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴ'.split('');

        el_chars = [];

        let el_jamos = Array.from(document.querySelectorAll('.jamo')).sort((a, b) => {
            let rect_a = a.getBoundingClientRect();
            let rect_b = b.getBoundingClientRect();
            return rect_a.left - rect_b.left;
        });

        let print = '';

        for(let el_jamo of el_jamos) {
            let jamo = el_jamo.dataset.jamo;
            let jamo_type = getJamoType(jamo);
            let el_rect = el_jamo.getBoundingClientRect();
            let x = el_rect.left + el_rect.width / 2;
            let y = el_rect.top + el_rect.height / 2;
            let min_d = Number.MAX_VALUE;
            let el_cho = null;
            if(jamo_type === 1) { // 중성 모음
                for(let other_jamo of el_jamos) {
                    if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                    let other_rect = other_jamo.getBoundingClientRect();
                    let other_x = other_rect.left + other_rect.width / 2;
                    let other_y = other_rect.top + other_rect.height / 2; 
                    if(el_jamo !== other_jamo) {
                        let dx = other_x - x;
                        let dy = other_y - y;
                        let d = Math.sqrt(dx * dx + dy * dy);
                        if(type_v.includes(jamo)) { // ㅏ type
                            if(dx < 0 && (other_y > y - jamo_size/2 && other_y < y + jamo_size/2)) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        } else if(type_h.includes(jamo)) { // ㅗ type
                            if(dy < 0) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        }        
                    }
                }

                if(el_cho) {
                    el_chars.push({
                        cho: el_cho,
                        jung: el_jamo,
                        jong: null,
                    });
                }
                window.el_chars = el_chars;
            }
        }

        let common_cho = ['ᄀ', 'ᄁ', 'ᄂ', 'ᄃ', 'ᄅ', 'ᄆ', 'ᄇ', 'ᄉ', 'ᄊ', 'ᄋ', 'ᄌ', 'ᄎ', 'ᄏ', 'ᄐ', 'ᄑ', 'ᄒ'];
        let common_jong = ['ᆨ', 'ᆩ', 'ᆫ', 'ᆮ', 'ᆯ', 'ᆷ', 'ᆸ', 'ᆺ', 'ᆻ', 'ᆼ', 'ᆽ', 'ᆾ', 'ᆿ', 'ᇀ', 'ᇁ', 'ᇂ'];

        for(let el_char of el_chars) {
            let rect = el_char.jung.getBoundingClientRect();
            let left = el_char.cho.getBoundingClientRect().left - jamo_size/2;
            let right = el_char.jung.getBoundingClientRect().right +  jamo_size/2;
            let candidates = [];
            for(let other_jamo of el_jamos) {
                if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                let other_rect = other_jamo.getBoundingClientRect();
                let other_x = other_rect.left + other_rect.width / 2;
                let other_y = other_rect.top + other_rect.height / 2;
                if(other_x > left && other_x < right) {
                    candidates.push(other_jamo);    
                }
            }
            if(candidates.length > 0) {
                candidates.sort((a, b) => b.getBoundingClientRect().top - a.getBoundingClientRect().top);
                if(el_char.cho !== candidates[0]) {
                    el_char.jong = candidates[0];
                }
            }

            let cho = el_char.cho.dataset.jamo;
            let jung = el_char.jung.dataset.jamo;
            let jong = el_char.jong ? el_char.jong.dataset.jamo : '';
            if(getJamoType(el_char.cho.dataset.jamo) === 2) { // 초성 자리에 모양이 같은 종성이 오면
                let idx = common_jong.indexOf(el_char.cho.dataset.jamo);
                cho = common_cho[idx];
            }

            if(el_char.jong) {
                if(getJamoType(el_char.jong.dataset.jamo) === 0) { // 종성 자리에 모양이 같은 초성이 오면
                    let idx = common_cho.indexOf(el_char.jong.dataset.jamo);
                    jong = common_jong[idx];
                }
            }
            

            print += cho + jung + jong;
        }

        document.querySelector('#test').value = print;
    }

    resize();
</script>