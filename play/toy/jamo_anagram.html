<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
<title>ÏûêÎ™® Ïñ¥Íµ¨Ï†ÑÏ≤†(Ïï†ÎÑàÍ∑∏Îû®)</title>
<style>
    body {
        overflow: hidden;
    }

    #answer {
        color: rgba(0, 0, 0, 1.0);
    }

    #stage {
        position: absolute;
        left: 0px;
        top: 0px;
    }

    .jamo {
        position: absolute;
        width: 10px;
        height: 10px;
        font-size: 100px;
        font-family: sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        /* border: 1px solid rgba(0, 0, 0, 0.25); */
        user-select: none;
        cursor: pointer;
        transition: text-shadow 0.5s;
    }

    .jamo:hover {
        -webkit-text-stroke: 3px blue;
        color: blue;
    }

    #ui-top {
        position: absolute;
        left: 20px;
        top: 20px;
    }

    #ui-bottom {
        position: absolute;
        right: 20px;
        bottom: 20px;
        text-align: right;
    }

    #ui-bottom input {
        border: none;
        text-align: right;
    }
</style>
<body>
    <div id="stage">
        <!--<div class="jamo" style="left: 200px; top: 300px">„Öé</div>-->
    </div>
    <div id="ui-top">
        <input type="checkbox" id="show-answer" checked>
        <input type="text" id="answer" spellcheck="false" autocomplete="off" value="ÌïúÎØ∏">
        <button id="quiz">Î¨∏Ï†ú ÎßåÎì§Í∏∞</button>
        <button id="random">üé≤</button>
        <button id="reset">Îã§Ïãú ÏãúÏûë</button>
    </div>
    <div id="ui-bottom">
        <input type="text" id="test" spellcheck="false" autocomplete="off" value="">
    </div>
</body>
<script>
    let params = new URLSearchParams(new URL(location.href).search);
    if(params.has('answer')) {
        document.querySelector('#show-answer').checked = false;
        document.querySelector('#answer').style.color = 'rgba(0, 0, 0, 0.0)';
        document.querySelector('#answer').value = params.get('answer');
    }
    let jamo_size = 100;

    function shuffle(array) {
        let n = array.length, t, i;
        while (n) {
            i = Math.random() * n-- | 0; // 0 ‚â§ i < n
            t = array[n];
            array[n] = array[i];
            array[i] = t;
        }
        return array;
    }

    let words = `ÏÇ¨Í≥º,ÏπúÍµ¨,ÌïôÍµê,ÏÑ†ÏÉù,Í∞ÄÏ°±,ÎÇòÎ¨¥,ÎèôÎ¨º,ÌïòÎäò,Î∞îÎã§,Í≥ÑÏ†à,ÏÇ¨Îûë,Í∏∞ÏÅ®,Ïä¨Ìîî,Ï±ÖÏÉÅ,Î¨∏Ï†ú,Î≥¥Î¨º,Ïö©Í∏∞,Ïã†Ìôî,ÎèôÌôî,Ïö¥Îèô,Ï∂ïÍµ¨,ÏùåÏïÖ,Î¨¥Ïö©,ÏòÅÌôî,ÎØ∏Ïà†,ÏãúÏû•,Í≥ºÏùº,ÏÉùÏùº,ÏÇ∞Ï±Ö,Ïó¨Ìñâ,Ï∂ïÏ†ú,Î¨∏Ìôî,Ï†ÑÌÜµ,Ïù∏ÏÇ¨,ÏÉàÏö∞,Ïö©ÏÇ¨,ÎßàÎ≤ï,ÏÜåÏõê,ÎπÑÎ∞Ä,Ïò∑Ïû•,Í±∞Ïö∏,Î∞òÏßÄ,ÎßàÏùå,Í∏∞Î∂Ñ,Î¨ºÍ±¥,ÏòàÏà†,ÏÇ¨ÏßÑ,ÎπµÏßë,ÏïÑÏπ®,Ï†êÏã¨,Ï†ÄÎÖÅ,ÏûêÏó∞,ÏãùÎ¨º,Í≥µÏõê,Ïà´Ïûê,Í≥ºÌïô,Ïñ∏Ïñ¥,Ìé∏ÏßÄ,ÏÑ†Î¨º,Ìú¥Ïãù,ÏâºÌÑ∞,Ï∫†ÌîÑ,ÌÖêÌä∏,ÏãúÍ≥®,Í∞ïÎ≥Ä,Ìï¥Î≥Ä,ÎØ∏Îûò,Í≥ºÍ±∞,ÌòÑÏû¨,ÏùºÍ∏∞,ÎßåÌôî,ÏòÅÏÉÅ,Ïó∞Í∑π,Î™®Îç∏,Î°úÎ¥á,Í∏∞Í≥Ñ,Ìä∏Îü≠,ÌëúÎ≤î,Î¨∏Ïñ¥,Ï∞∏ÏÉà,ÏÇ¨Ïä¥,ÌíçÏÑ†,Ï∂ïÍµ¨,ÎÜçÍµ¨,ÌÉÅÍµ¨,ÏàòÏòÅ,Ï±ÖÏÉÅ,Ïπ®ÎåÄ,Ï±ÖÏû•,Î∞ïÏ•ê,Î≤åÎ†à,ÎÜÄÏù¥,Í≥µÎ∂Ä,ÏàôÏ†ú,ÌñâÏÑ±,ÌÉúÏñë,Î™©ÏÑ±,ÌôîÏÑ±,Í∏àÏÑ±,ÏàòÏÑ±,ÌÜ†ÏÑ±,Íµ¨Î¶Ñ,Î∞îÎûå,Ïó¥Îß§,Ïî®Ïïó,Í±¥Î¨º,ÏãùÎ¨º,Îπ®Í∞ï,ÎÖ∏Îûë,Ï¥àÎ°ù,ÌååÎûë,Ï†ïÍ∏Ä,ÌÅ¨Î¶º,ÎßàÎ≤ï,ÎßàÏà†,ÏßÑÌôî,ÎààÎ¨º,Ìè≠Ìíç,ÌÉúÌíç,ÏôïÏûê,Í≥µÏ£º,Ïó¨Ïôï,ÏôïÍµ≠,Í¥ëÎåÄ,ÎßùÍ≥†,ÏàòÎ∞ï,Îî∏Í∏∞,ÏãùÏÇ¨,Îã¨Í±Ä,Ïó¨Î¶Ñ,Í≤®Ïö∏,Í∞ÄÏùÑ,ÌñáÎπõ,Îã¨Îπõ,ÌíÄÏûé,ÎÖ∏ÏùÑ,ÌÉêÏ†ï,`;
    words += `ÎπÑÌñâÍ∏∞,ÎèÑÏÑúÍ¥Ä,Ïö∞Ï£ºÏÑ†,ÎèôÎ¨ºÏõê,Î¨¥ÏßÄÍ∞ú,ÎßàÎ≤ïÏÇ¨,Ìï¥Ï†ÅÏÑ†,Î™®ÌóòÍ∞Ä,ÎØ∏Ïà†Í¥Ä,ÏòÅÌôîÍ¥Ä,Ïã†Í∏∞Î£®,ÏôïÏûêÎãò,Í≥µÏ£ºÎãò,ÎèÑÍπ®ÎπÑ,ÍøàÎÇòÎùº,Í∞ïÏïÑÏßÄ,Í≥†ÏñëÏù¥,Ìé∏ÏùòÏ†ê,Í∏∞Ï∞®Ïó≠,ÎåÄÌïôÍµê,ÏàòÏòÅÏû•,Í≤ΩÏ∞∞ÏÑú,ÏÜåÎ∞©ÏÑú,Î¨ºÎÜÄÏù¥,Ïó∞Ï£ºÌöå,ÏãùÎ¨ºÏõê,Î∞ïÎ¨ºÍ¥Ä,ÎèÑÏÑúÍ¥Ä,Í∏àÎ∂ïÏñ¥`;
    words += ``;
    words = shuffle(words.split(','));

    function quiz(answer) {
        clear();
        let el_answer = document.querySelector('#answer');
        let chars = answer.split('');
        //console.log(chars);
        let jamos = [];
        for(let ch of chars) {
            let decomposed = Array.from(ch.normalize('NFD'));
            //console.log(ch, decomposed);
            jamos.push(...decomposed);
        }
        let shuffled = shuffle(jamos);
        //console.log(shuffled);
        let x = jamo_size, y = 200;
        for(let jm of shuffled) {
            let jamo = document.createElement('div');
            jamo.dataset.jamo = jm;
            jamo.classList.add('jamo');
            jamo.innerText = jm;
            document.querySelector('#stage').appendChild(jamo);
            jamo.style.transform = `translate(${x}px, ${y}px)`;
            if(x + jamo_size * 1.5 > window.innerWidth) {
                y += jamo_size;
                x = jamo_size;
            }
            else {
                x += jamo_size;
            }
        }

        document.querySelector('#show-answer').checked = false;
        el_answer.style.color = 'rgba(0, 0, 0, 0.0)';
    }

    document.querySelector('#quiz').addEventListener('click', () => {
        let el_answer = document.querySelector('#answer');
        quiz(el_answer.value);
    });

    document.querySelector('#random').addEventListener('click', () => {
        let word = words.pop();
        words.unshift(word);
        quiz(word);
        document.querySelector('#answer').value = word;
    });

    function clear() {
        let stage = document.querySelector('#stage');
        stage.innerHTML = '';
        document.querySelector('#test').value = '';
    }

    document.querySelector('#reset').addEventListener('click', () => {
        document.querySelector('#answer').value = '';
        clear();
    });

    document.querySelector('#show-answer').addEventListener('change', (event) => {
        let answer = document.querySelector('#answer');
        if(event.target.checked) {
            answer.style.color = 'rgba(0, 0, 0, 1.0)';
        } else {
            answer.style.color = 'rgba(0, 0, 0, 0.0)';
        }
    });
    
    let selectedJamo = null;
    let offsetX = 0, offsetY = 0;

    function handleStart(event) {
        let target = event.target;
        if(target.classList.contains('jamo')) {
            selectedJamo = target;
            let rect = selectedJamo.getBoundingClientRect();

            if (event.type === 'mousedown') {
                offsetX = event.pageX - rect.left;
                offsetY = event.pageY - rect.top;
            } else if (event.type === 'touchstart') {
                offsetX = event.touches[0].pageX- rect.left;
                offsetY = event.touches[0].pageY - rect.top;
                
            }
            selectedJamo.style['-webkit-text-stroke'] = '3px blue';
            selectedJamo.style.color = 'blue';
        }
    }

    function handleMove(event) {
        // if(event.target.classList.contains('jamo')) {
        //     event.target.style['-webkit-text-stroke'] = '3px blue';
        //     event.target.style.color = 'blue';
        // }

        if(selectedJamo) {
            let x, y;
            if (event.type === 'mousemove') {
                x = event.pageX - offsetX;
                y = event.pageY - offsetY;
            } else if (event.type === 'touchmove') {
                x = event.touches[0].pageX - offsetX;
                y = event.touches[0].pageY - offsetY;
            }
            selectedJamo.style.transform = `translate(${x}px, ${y}px)`;
            selectedJamo.style['-webkit-text-stroke'] = '3px blue';
            selectedJamo.style.color = 'blue';
            compose();
        }
    }

    function handleEnd(event) {
        if(selectedJamo) {
            selectedJamo.style['-webkit-text-stroke'] = '';
            selectedJamo.style.color = '';
        }
        selectedJamo = null;
        is_correct();
    }

    function resize() {
        // Í∞ÄÎ°úÍ∞Ä ÏÑ∏Î°úÎ≥¥Îã§ ÏûëÏúºÎ©¥ Í∏∞Ï°¥Ïùò style ruleÏóêÏÑú classÍ∞Ä jamo Ïù∏Í≤ÉÏùò font-sizeÎ•º 50pxÎ°ú ÏÑ§Ï†ï
        if(window.innerWidth < window.innerHeight) {
            jamo_size = 50;
            let styleSheet = document.styleSheets[0];
            let cssRules = Array.from(styleSheet.cssRules || styleSheet.rules);
            let rule = cssRules.filter(x => x.selectorText == '.jamo')[0];
            rule.style.fontSize = `${jamo_size}px`;
        }  
        else {
            jamo_size = 100;
        }     
    }

    document.addEventListener('resize', (event) => {
        setTimeout(() => {
            resize();
        }, 100);
    });

    document.addEventListener('mousedown', handleStart);
    document.addEventListener('touchstart', handleStart);

    document.addEventListener('mousemove', handleMove);
    document.addEventListener('touchmove', handleMove);

    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchend', handleEnd);

    // document.addEventListener('mouseleave', (event) => {
    //     if(event.target.classList.contains('jamo')) {
    //         console.log('!');
    //         event.target.style['-webkit-text-stroke'] = '';
    //         event.target.style.color = 'black';
    //     }
    // });

    document.addEventListener('contextmenu', (event) => {
        event.preventDefault();
    });

    document.addEventListener('dragstart', (event) => {
        event.preventDefault();
    });

    function getJamoType(char) {
        const codePoint = char.codePointAt(0);

        // Ï¥àÏÑ± (Leading consonants): U+1100 ‚Äì U+1112 (19Ïûê)
        // ·ÑÄ·ÑÅ·ÑÇ·ÑÉ·ÑÑ·ÑÖ·ÑÜ·Ñá·Ñà·Ñâ·Ñä·Ñã·Ñå·Ñç·Ñé·Ñè·Ñê·Ñë·Ñí
        if (codePoint >= 0x1100 && codePoint <= 0x1112) {
            return 0;
        }

        // Ï§ëÏÑ± (Vowels): U+1161 ‚Äì U+1175 (21Ïûê)
        // ·Ö°·Ö¢·Ö£·Ö§·Ö•·Ö¶·Öß·Ö®·Ö©·Ö™·Ö´·Ö¨·Ö≠·ÖÆ·ÖØ·Ö∞·Ö±·Ö≤·Ö≥·Ö¥·Öµ
        if (codePoint >= 0x1161 && codePoint <= 0x1175) {
            return 1;
        }

        // Ï¢ÖÏÑ± (Trailing consonants): U+11A8 ‚Äì U+11C2 (27Ïûê), U+11A7 (Ï¢ÖÏÑ±Ïù¥ ÏóÜÎäî Í≤ΩÏö∞)
        // ·Ü®·Ü©·Ü™·Ü´·Ü¨·Ü≠·ÜÆ·ÜØ·Ü∞·Ü±·Ü≤·Ü≥·Ü¥·Üµ·Ü∂·Ü∑·Ü∏·Üπ·Ü∫·Üª·Üº·ÜΩ·Üæ·Üø·áÄ·áÅ·áÇ
        if ((codePoint >= 0x11A8 && codePoint <= 0x11C2) || codePoint === 0x11A7) {
            return 2;
        }

        // const syllable = 0xAC00 + (choIndex * 21 * 28) + (jungIndex * 28) + jongIndex;

        return -1;
    }

    function compose() {
        // ·Ö°·Ö¢·Ö£·Ö§·Ö•·Ö¶·Öß·Ö®·Ö©·Ö™·Ö´·Ö¨·Ö≠·ÖÆ·ÖØ·Ö∞·Ö±·Ö≤·Ö≥·Ö¥·Öµ
        let type_v = '·Ö°·Ö¢·Ö£·Ö§·Ö•·Ö¶·Öß·Ö®·Öµ'.split('');
        let type_h = '·Ö©·Ö™·Ö´·Ö¨·Ö≠·ÖÆ·ÖØ·Ö∞·Ö±·Ö≤·Ö≥·Ö¥'.split('');

        el_chars = [];

        let el_jamos = Array.from(document.querySelectorAll('.jamo')).sort((a, b) => {
            let rect_a = a.getBoundingClientRect();
            let rect_b = b.getBoundingClientRect();
            return rect_a.left - rect_b.left;
        });

        let print = '';

        for(let el_jamo of el_jamos) {
            let jamo = el_jamo.dataset.jamo;
            let jamo_type = getJamoType(jamo);
            let el_rect = el_jamo.getBoundingClientRect();
            let x = el_rect.left + el_rect.width / 2;
            let y = el_rect.top + el_rect.height / 2;
            let min_d = Number.MAX_VALUE;
            let el_cho = null;
            if(jamo_type === 1) { // Ï§ëÏÑ± Î™®Ïùå
                for(let other_jamo of el_jamos) {
                    if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                    let other_rect = other_jamo.getBoundingClientRect();
                    let other_x = other_rect.left + other_rect.width / 2;
                    let other_y = other_rect.top + other_rect.height / 2; 
                    if(el_jamo !== other_jamo) {
                        let dx = other_x - x;
                        let dy = other_y - y;
                        let d = Math.sqrt(dx * dx + dy * dy);
                        if(type_v.includes(jamo)) { // „Öè type
                            if(dx < 0 && (other_y > y - jamo_size/2 && other_y < y + jamo_size/2)) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        } else if(type_h.includes(jamo)) { // „Öó type
                            if(dy < 0) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        }        
                    }
                }

                if(el_cho) {
                    el_chars.push({
                        cho: el_cho,
                        jung: el_jamo,
                        jong: null,
                    });
                }
                window.el_chars = el_chars;
            }
        }

        let common_cho = ['·ÑÄ', '·ÑÅ', '·ÑÇ', '·ÑÉ', '·ÑÖ', '·ÑÜ', '·Ñá', '·Ñâ', '·Ñä', '·Ñã', '·Ñå', '·Ñé', '·Ñè', '·Ñê', '·Ñë', '·Ñí'];
        let common_jong = ['·Ü®', '·Ü©', '·Ü´', '·ÜÆ', '·ÜØ', '·Ü∑', '·Ü∏', '·Ü∫', '·Üª', '·Üº', '·ÜΩ', '·Üæ', '·Üø', '·áÄ', '·áÅ', '·áÇ'];

        for(let el_char of el_chars) {
            let rect = el_char.jung.getBoundingClientRect();
            let left = el_char.cho.getBoundingClientRect().left - jamo_size/2;
            let right = el_char.jung.getBoundingClientRect().right +  jamo_size/2;
            let candidates = [];
            for(let other_jamo of el_jamos) {
                if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                let other_rect = other_jamo.getBoundingClientRect();
                let other_x = other_rect.left + other_rect.width / 2;
                let other_y = other_rect.top + other_rect.height / 2;
                if(other_x > left && other_x < right) {
                    candidates.push(other_jamo);    
                }
            }
            if(candidates.length > 0) {
                candidates.sort((a, b) => b.getBoundingClientRect().top - a.getBoundingClientRect().top);
                if(el_char.cho !== candidates[0]) {
                    el_char.jong = candidates[0];
                }
            }

            let cho = el_char.cho.dataset.jamo;
            let jung = el_char.jung.dataset.jamo;
            let jong = el_char.jong ? el_char.jong.dataset.jamo : '';
            if(getJamoType(el_char.cho.dataset.jamo) === 2) { // Ï¥àÏÑ± ÏûêÎ¶¨Ïóê Î™®ÏñëÏù¥ Í∞ôÏùÄ Ï¢ÖÏÑ±Ïù¥ Ïò§Î©¥
                let idx = common_jong.indexOf(el_char.cho.dataset.jamo);
                cho = common_cho[idx];
            }

            if(el_char.jong) {
                if(getJamoType(el_char.jong.dataset.jamo) === 0) { // Ï¢ÖÏÑ± ÏûêÎ¶¨Ïóê Î™®ÏñëÏù¥ Í∞ôÏùÄ Ï¥àÏÑ±Ïù¥ Ïò§Î©¥
                    let idx = common_cho.indexOf(el_char.jong.dataset.jamo);
                    jong = common_jong[idx];
                }
            }
            

            print += cho + jung + jong;
        }

        document.querySelector('#test').value = print;
    }

    function is_correct() {
        let answer = document.querySelector('#answer').value.normalize('NFD');
        let test = document.querySelector('#test').value.normalize('NFD');
        if(answer == test) {
            for(let el_jamo of document.querySelectorAll('.jamo')) {
                let hue = Math.random() * 360;
                el_jamo.style.textShadow = `0px 0px ${jamo_size/4}px hsl(${hue}, 100%, 70%)`;
            }
            document.querySelector('#show-answer').checked = true;
            document.querySelector('#answer').style.color = 'rgba(0, 0, 0, 1.0)';
        }
        else {
            for(let el_jamo of document.querySelectorAll('.jamo')) {
                el_jamo.style.textShadow = '';
            }
        }
    }

    resize();
</script>