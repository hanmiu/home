<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
<title>자모 어구전철(애너그램)</title>
<style>
    body {
        overflow: hidden;
        touch-action: none;
    }

    #answer {
        color: rgba(0, 0, 0, 1.0);
    }

    #stage {
        position: absolute;
        left: 0px;
        top: 0px;
    }

    .jamo {
        position: absolute;
        width: 10px;
        height: 10px;
        font-size: 100px;
        font-family: sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        /* border: 1px solid rgba(0, 0, 0, 0.25); */
        user-select: none;
        cursor: pointer;
        transition: text-shadow 0.5s;
    }

    .jamo:hover {
        -webkit-text-stroke: 3px blue;
        color: blue;
    }

    #ui-top {
        position: absolute;
        left: 20px;
        top: 20px;
    }

    #ui-bottom {
        position: absolute;
        right: 20px;
        bottom: 20px;
        text-align: right;
    }

    #ui-bottom input {
        border: none;
        text-align: right;
    }
</style>
<body>
    <div id="stage">
        <!--<div class="jamo" style="left: 200px; top: 300px">ㅎ</div>-->
    </div>
    <div id="ui-top">
        <input type="checkbox" id="show-answer" checked>
        <input type="text" id="answer" spellcheck="false" autocomplete="off" value="한미" size="10">
        <button id="quiz">문제 만들기</button>
        <button id="random2">②</button>
        <button id="random3">③</button>
        <button id="random4">④</button>
        <button id="reset">다시 시작</button>
    </div>
    <div id="ui-bottom">
        <input type="text" id="test" spellcheck="false" autocomplete="off" value="">
    </div>
</body>
<script>
    let params = new URLSearchParams(new URL(location.href).search);
    if(params.has('answer')) {
        document.querySelector('#show-answer').checked = false;
        document.querySelector('#answer').style.color = 'rgba(0, 0, 0, 0.0)';
        document.querySelector('#answer').value = params.get('answer');
    }
    let jamo_size = 100;

    function shuffle(array) {
        let n = array.length, t, i;
        while (n) {
            i = Math.random() * n-- | 0; // 0 ≤ i < n
            t = array[n];
            array[n] = array[i];
            array[i] = t;
        }
        return array;
    }

    let words2 = shuffle(`사과,친구,학교,생선,가족,나무,동물,하늘,바다,계절,사랑,기쁨,슬픔,책상,문제,보물,용기,신화,동화,운동,축구,음악,무용,영화,미술,시장,과일,감자,생일,산책,여행,축제,문화,전통,인사,용사,모험,탐험,탐구,문제,무한,공간,시간,생명,신비,관찰,질서,흐름,모양,영웅,해적,요정,괴물,그림,희망,소원,비밀,옷장,거울,반지,팔찌,보석,마음,기분,물건,예술,사진,빵집,아침,점심,저녁,자연,식물,공원,숫자,과학,언어,편지,선물,휴식,쉼터,캠프,텐트,시골,강변,해변,입체,동굴,옥상,시골,현재,일기,만화,영상,연극,극장,공연,모델,로봇,트럭,표범,문어,참새,사슴,풍선,축구,농구,탁구,수영,책상,침대,책장,박쥐,황소,벌레,놀이,공부,숙제,행성,태양,목성,화성,금성,수성,토성,구름,바람,열매,씨앗,건물,식물,빨강,노랑,초록,파랑,정글,크림,마법,마술,진화,눈물,폭풍,태풍,왕자,공주,여왕,왕국,광대,망고,당근,수박,딸기,식사,달걀,여름,겨울,가을,계절,햇빛,달빛,풀잎,노을,탐정,화산,어른,삼촌,엄마,공룡,나방,버섯,은하,동해,남해,남극,북극,용암,얼음,날씨,홍수,폭우,우박,호박,상어,외식,비밀,옷장,방학,튀김,소금,설탕,동전,추석,설날,서울,떡국,병원,약국,장미,낙타,펭귄,침대,계곡,방패,갑옷,헬멧,공기,온도,실망,기쁨,슬픔,행복,갯벌,도둑,감옥,경찰,일본,중국,미국,영국,인도,화장,장화,공장,사람,사랑,반달,손님,마을,목욕,게임,실수,만두,국어,영어,칭찬,색깔,생각,세상,배움,사전,감정,깃털,인간,역사,트림,방귀,엉망,청소,환경,여행,간식,소풍,주문,농장`.split(','));
    let words3 = shuffle(`호기심,그림자,은하수,태양계,한라산,백두산,주사위,비행기,도서관,수족관,박물관,천문대,우주선,동물원,무지개,목걸이,마법사,해적선,모험가,미술관,영화관,신기루,왕자님,공주님,도깨비,꿈나라,강아지,고양이,편의점,기차역,중학교,대학교,대학생,수영장,경찰서,소방서,소방관,대통령,물놀이,연주회,식물원,박물관,도서관,금붕어,모래성,눈사람,유치원,어린이,선생님,할머니,달팽이,사마귀,올빼비,독수리,까마귀,북극곰,나무꾼,종달새,참나무,소나무,메뚜기,개나리,진달래,나뭇잎,놀이터,잠자리,오징어,옥수수,회사원,망원경,현미경,코뿔소,코끼리,원숭이,안전띠,유니콘,갈매기,도마뱀,드래곤,반딧불,별똥별,수증기,월요일,금요일,목요일,화장실,보름달,팥빙수,신기루,카메라,그림책,그림자,운동화,운동장,컴퓨터,외계인,쓰레기,목욕탕,색연필,동화책,지구본,우주선,도시락,별자리,상상력,자전거,구조대,장난감,구급차,자동차,음식점,심부름`.split(','));
    let words4 = shuffle(`수수께끼,백과사전,호랑나비,해바라기,자작나무,허수아비,대한민국,미끄럼틀,밀짚모자,할아버지,바다표범,사슴벌레,딱정벌레,무당벌레,귀뚜라미,놀이공원,어린이집,초등학교,초등학생,고등학교,고등학생,엉망진창,은근슬쩍,헐레벌떡,불꽃놀이,야생동물,비밀번호,비밀기지,가족여행,사과나무,카멜레온,예방주사,일기예보,미세먼지,안전운전,나무늘보,바이올린,스마트폰,종이접기,인공지능,모래시계,손목시계,백설공주,인어공주,고슴도치,쓰레기통,된장찌개,김치찌개,스파게티,뭉게구름,송이버섯,흔들의자`.split(','));

    function quiz(answer) {
        clear();
        let el_answer = document.querySelector('#answer');
        let chars = answer.split('');
        //console.log(chars);
        let jamos = [];
        for(let ch of chars) {
            let decomposed = Array.from(ch.normalize('NFD'));
            //console.log(ch, decomposed);
            jamos.push(...decomposed);
        }
        let shuffled = shuffle(jamos);
        //console.log(shuffled);
        let x = jamo_size, y = 200;
        for(let jm of shuffled) {
            let jamo = document.createElement('div');
            jamo.dataset.jamo = jm;
            jamo.classList.add('jamo');
            jamo.innerText = jm;
            document.querySelector('#stage').appendChild(jamo);
            jamo.style.transform = `translate(${x}px, ${y}px)`;
            if(x + jamo_size * 1.5 > window.innerWidth) {
                y += jamo_size;
                x = jamo_size;
            }
            else {
                x += jamo_size;
            }
        }

        document.querySelector('#show-answer').checked = false;
        el_answer.style.color = 'rgba(0, 0, 0, 0.0)';
    }

    document.querySelector('#quiz').addEventListener('click', () => {
        let el_answer = document.querySelector('#answer');
        quiz(el_answer.value);
    });

    document.querySelector('#random2').addEventListener('click', () => {
        let word = words2.pop();
        words2.unshift(word);
        quiz(word);
        document.querySelector('#answer').value = word;
    });

    document.querySelector('#random3').addEventListener('click', () => {
        let word = words3.pop();
        words3.unshift(word);
        quiz(word);
        document.querySelector('#answer').value = word;
    });

    document.querySelector('#random4').addEventListener('click', () => {
        let word = words4.pop();
        words4.unshift(word);
        quiz(word);
        document.querySelector('#answer').value = word;
    });

    function clear() {
        let stage = document.querySelector('#stage');
        stage.innerHTML = '';
        document.querySelector('#test').value = '';
    }

    document.querySelector('#reset').addEventListener('click', () => {
        document.querySelector('#answer').value = '';
        clear();
    });

    document.querySelector('#show-answer').addEventListener('change', (event) => {
        let answer = document.querySelector('#answer');
        if(event.target.checked) {
            answer.style.color = 'rgba(0, 0, 0, 1.0)';
        } else {
            answer.style.color = 'rgba(0, 0, 0, 0.0)';
        }
    });
    
    let selectedJamo = null;
    let offsetX = 0, offsetY = 0;

    function handleStart(event) {
        let target = event.target;
        if(target.classList.contains('jamo')) {
            selectedJamo = target;
            let rect = selectedJamo.getBoundingClientRect();

            if (event.type === 'mousedown') {
                offsetX = event.pageX - rect.left;
                offsetY = event.pageY - rect.top;
            } else if (event.type === 'touchstart') {
                offsetX = event.touches[0].pageX- rect.left;
                offsetY = event.touches[0].pageY - rect.top;
                
            }
            selectedJamo.style['-webkit-text-stroke'] = '3px blue';
            selectedJamo.style.color = 'blue';
        }
    }

    function handleMove(event) {
        // if(event.target.classList.contains('jamo')) {
        //     event.target.style['-webkit-text-stroke'] = '3px blue';
        //     event.target.style.color = 'blue';
        // }

        if(selectedJamo) {
            let x, y;
            if (event.type === 'mousemove') {
                x = event.pageX - offsetX;
                y = event.pageY - offsetY;
            } else if (event.type === 'touchmove') {
                // event.preventDefault();
                x = event.touches[0].pageX - offsetX;
                y = event.touches[0].pageY - offsetY;
            }
            selectedJamo.style.transform = `translate(${x}px, ${y}px)`;
            selectedJamo.style['-webkit-text-stroke'] = '3px blue';
            selectedJamo.style.color = 'blue';
            compose();
        }
    }

    function handleEnd(event) {
        if(selectedJamo) {
            selectedJamo.style['-webkit-text-stroke'] = '';
            selectedJamo.style.color = '';
        }
        selectedJamo = null;
        is_correct();
    }

    function resize() {
        // 가로가 세로보다 작으면 기존의 style rule에서 class가 jamo 인것의 font-size를 50px로 설정
        if(window.innerWidth < window.innerHeight) {
            jamo_size = 50;
            let styleSheet = document.styleSheets[0];
            let cssRules = Array.from(styleSheet.cssRules || styleSheet.rules);
            let rule = cssRules.filter(x => x.selectorText == '.jamo')[0];
            rule.style.fontSize = `${jamo_size}px`;
        }  
        else {
            jamo_size = 100;
        }     
    }

    window.addEventListener('resize', (event) => {
        setTimeout(() => {
            resize();
        }, 100);
    });

    window.addEventListener("orientationchange", (event) => {
        setTimeout(() => {
            resize();
        }, 100);
    });

    window.addEventListener('mousedown', handleStart);
    window.addEventListener('touchstart', handleStart);

    window.addEventListener('mousemove', handleMove);
    window.addEventListener('touchmove', handleMove);

    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchend', handleEnd);

    // document.addEventListener('mouseleave', (event) => {
    //     if(event.target.classList.contains('jamo')) {
    //         console.log('!');
    //         event.target.style['-webkit-text-stroke'] = '';
    //         event.target.style.color = 'black';
    //     }
    // });

    document.addEventListener('contextmenu', (event) => {
        event.preventDefault();
        event.stopPropagation();
    });

    // document.addEventListener('dragstart', (event) => {
    //     event.preventDefault();
    // });

    function getJamoType(char) {
        const codePoint = char.codePointAt(0);

        // 초성 (Leading consonants): U+1100 – U+1112 (19자)
        // ᄀᄁᄂᄃᄄᄅᄆᄇᄈᄉᄊᄋᄌᄍᄎᄏᄐᄑᄒ
        if (codePoint >= 0x1100 && codePoint <= 0x1112) {
            return 0;
        }

        // 중성 (Vowels): U+1161 – U+1175 (21자)
        // ᅡᅢᅣᅤᅥᅦᅧᅨᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴᅵ
        if (codePoint >= 0x1161 && codePoint <= 0x1175) {
            return 1;
        }

        // 종성 (Trailing consonants): U+11A8 – U+11C2 (27자), U+11A7 (종성이 없는 경우)
        // ᆨᆩᆪᆫᆬᆭᆮᆯᆰᆱᆲᆳᆴᆵᆶᆷᆸᆹᆺᆻᆼᆽᆾᆿᇀᇁᇂ
        if ((codePoint >= 0x11A8 && codePoint <= 0x11C2) || codePoint === 0x11A7) {
            return 2;
        }

        // const syllable = 0xAC00 + (choIndex * 21 * 28) + (jungIndex * 28) + jongIndex;

        return -1;
    }

    function compose() {
        // ᅡᅢᅣᅤᅥᅦᅧᅨᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴᅵ
        let type_v = 'ᅡᅢᅣᅤᅥᅦᅧᅨᅵ'.split('');
        let type_h = 'ᅩᅪᅫᅬᅭᅮᅯᅰᅱᅲᅳᅴ'.split('');

        el_chars = [];

        let el_jamos = Array.from(document.querySelectorAll('.jamo')).sort((a, b) => {
            let rect_a = a.getBoundingClientRect();
            let rect_b = b.getBoundingClientRect();
            return rect_a.left - rect_b.left;
        });

        let print = '';

        for(let el_jamo of el_jamos) {
            let jamo = el_jamo.dataset.jamo;
            let jamo_type = getJamoType(jamo);
            let el_rect = el_jamo.getBoundingClientRect();
            let x = el_rect.left + el_rect.width / 2;
            let y = el_rect.top + el_rect.height / 2;
            let min_d = Number.MAX_VALUE;
            let el_cho = null;
            if(jamo_type === 1) { // 중성 모음
                for(let other_jamo of el_jamos) {
                    if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                    let other_rect = other_jamo.getBoundingClientRect();
                    let other_x = other_rect.left + other_rect.width / 2;
                    let other_y = other_rect.top + other_rect.height / 2; 
                    if(el_jamo !== other_jamo) {
                        let dx = other_x - x;
                        let dy = other_y - y;
                        let d = Math.sqrt(dx * dx + dy * dy);
                        if(type_v.includes(jamo)) { // ㅏ type
                            if(dx < 0 && (other_y > y - jamo_size/2 && other_y < y + jamo_size/2)) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        } else if(type_h.includes(jamo)) { // ㅗ type
                            if(dy < 0) {
                                if(d < min_d) {
                                    min_d = d;
                                    el_cho = other_jamo;
                                }
                            }
                        }        
                    }
                }

                if(el_cho) {
                    el_chars.push({
                        cho: el_cho,
                        jung: el_jamo,
                        jong: null,
                    });
                }
                window.el_chars = el_chars;
            }
        }

        let common_cho = ['ᄀ', 'ᄁ', 'ᄂ', 'ᄃ', 'ᄅ', 'ᄆ', 'ᄇ', 'ᄉ', 'ᄊ', 'ᄋ', 'ᄌ', 'ᄎ', 'ᄏ', 'ᄐ', 'ᄑ', 'ᄒ'];
        let common_jong = ['ᆨ', 'ᆩ', 'ᆫ', 'ᆮ', 'ᆯ', 'ᆷ', 'ᆸ', 'ᆺ', 'ᆻ', 'ᆼ', 'ᆽ', 'ᆾ', 'ᆿ', 'ᇀ', 'ᇁ', 'ᇂ'];

        for(let el_char of el_chars) {
            let rect = el_char.jung.getBoundingClientRect();
            let left = el_char.cho.getBoundingClientRect().left - jamo_size/2;
            let right = el_char.jung.getBoundingClientRect().right +  jamo_size/2;
            let candidates = [];
            for(let other_jamo of el_jamos) {
                if(getJamoType(other_jamo.dataset.jamo) === 1) continue;
                let other_rect = other_jamo.getBoundingClientRect();
                let other_x = other_rect.left + other_rect.width / 2;
                let other_y = other_rect.top + other_rect.height / 2;
                if(other_x > left && other_x < right) {
                    candidates.push(other_jamo);    
                }
            }
            if(candidates.length > 0) {
                candidates.sort((a, b) => b.getBoundingClientRect().top - a.getBoundingClientRect().top);
                if(el_char.cho !== candidates[0]) {
                    el_char.jong = candidates[0];
                }
            }

            let cho = el_char.cho.dataset.jamo;
            let jung = el_char.jung.dataset.jamo;
            let jong = el_char.jong ? el_char.jong.dataset.jamo : '';
            if(getJamoType(el_char.cho.dataset.jamo) === 2) { // 초성 자리에 모양이 같은 종성이 오면
                let idx = common_jong.indexOf(el_char.cho.dataset.jamo);
                cho = common_cho[idx];
            }

            if(el_char.jong) {
                if(getJamoType(el_char.jong.dataset.jamo) === 0) { // 종성 자리에 모양이 같은 초성이 오면
                    let idx = common_cho.indexOf(el_char.jong.dataset.jamo);
                    jong = common_jong[idx];
                }
            }
            

            print += cho + jung + jong;
        }

        document.querySelector('#test').value = print;
    }

    function is_correct() {
        let answer = document.querySelector('#answer').value.normalize('NFD');
        let test = document.querySelector('#test').value.normalize('NFD');
        if(answer == test) {
            for(let el_jamo of document.querySelectorAll('.jamo')) {
                let hue = Math.random() * 360;
                el_jamo.style.textShadow = `0px 0px ${jamo_size/4}px hsl(${hue}, 100%, 70%)`;
            }
            document.querySelector('#show-answer').checked = true;
            document.querySelector('#answer').style.color = 'rgba(0, 0, 0, 1.0)';
        }
        else {
            for(let el_jamo of document.querySelectorAll('.jamo')) {
                el_jamo.style.textShadow = '';
            }
        }
    }

    resize();
</script>