<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계단</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #jumpStrength {
            width: 200px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="jumpStrength">점프 강도: <span id="jumpStrengthValue">0.03</span></label>
        <input type="range" id="jumpStrength" min="0.01" max="0.1" step="0.01" value="0.03">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        // Matter.js 모듈 정의
        const Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite,
            Body = Matter.Body,
            Vector = Matter.Vector,
            Events = Matter.Events;

        const engine = Engine.create({
            positionIterations: 10,
            velocityIterations: 10
        });
        const world = engine.world;

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: window.innerWidth,
                height: window.innerHeight,
                wireframes: false,
                background: '#f0f0f0'
            }
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // 계단 생성 함수
        function generateStaircase(
            startX, startY,
            stepWidth, stepHeight,
            perturbationRange,
            steps,
            direction
        ) {
            let currentX = startX;
            let currentY = startY;
            const points = [[currentX, currentY]];

            const directionMultiplier = direction === 'right' ? 1 : -1;

            for (let i = 0; i < steps; i++) {
                // 첫 번째 수평 이동 (1/3)
                currentX += (stepWidth / 3 + (Math.random() * 2 - 1) * perturbationRange) * directionMultiplier;
                currentY += (Math.random() * 2 - 1) * perturbationRange;
                points.push([currentX, currentY]);

                // 수직 이동
                currentY -= stepHeight + (Math.random() * 2 - 1) * perturbationRange;
                currentX += (Math.random() * 2 - 1) * perturbationRange * directionMultiplier;
                points.push([currentX, currentY]);

                // 두 번째 수평 이동 (2/3)
                currentX += ((stepWidth * 2 / 3) + (Math.random() * 2 - 1) * perturbationRange) * directionMultiplier;
                currentY += (Math.random() * 2 - 1) * perturbationRange;
                points.push([currentX, currentY]);
            }

            return points;
        }

        // Matter.js 용 계단 생성 함수
        function createStaircase(startX, startY, stepWidth, stepHeight, perturbationRange, steps, direction) {
            const points = generateStaircase(startX, startY, stepWidth, stepHeight, perturbationRange, steps, direction);
            const stairParts = [];

            for (let i = 0; i < points.length - 1; i++) {
                const [x1, y1] = points[i];
                const [x2, y2] = points[i + 1];
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;
                const width = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                const angle = Math.atan2(y2 - y1, x2 - x1);

                const part = Bodies.rectangle(midX, midY, width, 10, {
                    isStatic: true,
                    angle: angle,
                    friction: 1,
                    render: {
                        fillStyle: '#4a4a4a',
                        strokeStyle: '#2a2a2a',
                        lineWidth: 1
                    }
                });

                stairParts.push(part);
            }

            return stairParts;
        }

        // 플레이어 생성 함수
        function createPlayer(x, y) {
            const radius = 15;
            const player = Bodies.circle(x, y, radius, {
                density: 0.001,
                friction: 0.1,
                restitution: 0,
                render: {
                    fillStyle: '#3498db',
                    strokeStyle: '#2980b9',
                    lineWidth: 2
                }
            });
            return player;
        }

        // 계단 생성
        const staircase = createStaircase(100, window.innerHeight - 50, 100, 60, 5, 20, 'right');
        Composite.add(world, staircase);

        // 플레이어 생성 및 추가
        const spawnPoint = { x: 150, y: window.innerHeight - 300 };
        let player = createPlayer(spawnPoint.x, spawnPoint.y);
        Composite.add(world, player);

        // 바닥 생성
        const ground = Bodies.rectangle(window.innerWidth / 2, window.innerHeight, window.innerWidth, 50, { 
            isStatic: true,
            render: {
                fillStyle: '#2c3e50'
            }
        });
        Composite.add(world, ground);

        // 카메라 팔로우
        Events.on(render, 'afterRender', function() {
            Render.lookAt(render, player, {
                x: window.innerWidth / 2,
                y: window.innerHeight / 2
            });
        });

        // 리스폰 함수
        function respawnPlayer() {
            Composite.remove(world, player);
            player = createPlayer(spawnPoint.x, spawnPoint.y);
            Composite.add(world, player);
        }

        // 플레이어 위치 체크 및 리스폰
        Events.on(engine, 'afterUpdate', function() {
            if (player.position.y > window.innerHeight + 100) {
                respawnPlayer();
            }
        });

        // 점프 강도 슬라이더
        const jumpStrengthSlider = document.getElementById('jumpStrength');
        const jumpStrengthValue = document.getElementById('jumpStrengthValue');
        let jumpStrength = parseFloat(jumpStrengthSlider.value);

        jumpStrengthSlider.addEventListener('input', function() {
            jumpStrength = parseFloat(this.value);
            jumpStrengthValue.textContent = jumpStrength.toFixed(2);
        });

        // 벡터 기반 점프 함수
        function vectorJump(startX, startY, endX, endY) {
            const jumpVector = Vector.sub(
                Vector.create(endX, endY),
                Vector.create(startX, startY)
            );
            const normalizedJumpVector = Vector.normalise(jumpVector);
            const jumpForce = Vector.mult(normalizedJumpVector, jumpStrength);
            Body.applyForce(player, player.position, jumpForce);
        }

        // 이동 함수
        function move(direction) {
            Body.applyForce(player, player.position, { x: direction * 0.001, y: 0 });
        }

        // 키보드 이벤트
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case ' ':
                case 'ArrowUp':
                    vectorJump(player.position.x, player.position.y, player.position.x, player.position.y - 50);
                    break;
                case 'ArrowLeft':
                    move(-1);
                    break;
                case 'ArrowRight':
                    move(1);
                    break;
            }
        });

        // 터치 이벤트
        let touchStartX = 0;
        let touchStartY = 0;
        document.addEventListener('touchstart', function(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        });

        document.addEventListener('touchend', function(event) {
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            vectorJump(touchStartX, touchStartY, touchEndX, touchEndY);
        });

        // 마우스 이벤트
        let mouseStartX = 0;
        let mouseStartY = 0;
        let isMouseDown = false;

        document.addEventListener('mousedown', function(event) {
            mouseStartX = event.clientX;
            mouseStartY = event.clientY;
            isMouseDown = true;
        });

        document.addEventListener('mouseup', function(event) {
            if (isMouseDown) {
                const mouseEndX = event.clientX;
                const mouseEndY = event.clientY;
                vectorJump(mouseStartX, mouseStartY, mouseEndX, mouseEndY);
            }
            isMouseDown = false;
        });

        // 윈도우 리사이즈 이벤트
        window.addEventListener('resize', function() {
            render.canvas.width = window.innerWidth;
            render.canvas.height = window.innerHeight;
            Render.setPixelRatio(render, window.devicePixelRatio);
        });
    </script>
</body>
</html>