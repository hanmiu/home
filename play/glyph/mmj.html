<!doctype html>
<meta charset="utf-8">
<title>몸문자</title>
<style title="main">
  @import url('https://fonts.googleapis.com/css?family=Black+Han+Sans');
  @import url('https://fonts.googleapis.com/css?family=Do+Hyeon');
  
  html {
    overflow: hidden; 
  }
  
  body {
    margin: 0;
    user-select: none;
    overflow: hidden;
  }
  
  .glyph {
  }
  
  .desc {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 30px;
    /*
    fill: black;
    transition: transform 0.2s;
    */
    transform: translate(0px, 100px);
  }
  
  .gpath {
    fill: blue;
    cursor: pointer;
  }
  
  #ui {
    position: fixed;
    left: 0px;
    top: 0px;
    width: 100vw;
    height: 10vh;
    background-color: #30f09f;
  }
  
  #svg {
    position: fixed;
  }
</style>
<body>
  <svg id="svg"></svg>
  <div id="ui">
    <input type="checkbox" id="show-desc">
  </div>
</body>
<script>
  let svg_ns = 'http://www.w3.org/2000/svg';
  let el_svg = document.querySelector('#svg');
  let el_ui = document.querySelector('#ui');
  let rect_ui = el_ui.getBoundingClientRect();
  
  let checkbox_show_desc = document.querySelector('#show-desc');
  
  let main_stylesheet = [].slice.call(document.styleSheets).filter(x => x.title == 'main')[0];
  
  function get_style_rule(selectorText) {
    return [].slice.call(main_stylesheet.cssRules).filter(x => x.selectorText == selectorText)[0];
  }
  
  let style_desc = get_style_rule('.desc').style;
  
  let files = [
    '새.svg',
    '모른다.svg',
    '풀 위에 토끼.svg',
  ];
  
  let dom_parser = new DOMParser();
  
  for(let file of files) {
    fetch('./data/mmj/' + file)
    .then(response => response.text())
    .then(text => {
      let xml = dom_parser.parseFromString(text, 'text/xml');
      let paths = xml.querySelectorAll('path');
      for(let i = 0; i < paths.length; i++) {
        let d = paths[i].getAttribute('d');
        if(d.trim().length > 0) {
          let group = document.createElementNS(svg_ns, 'g');
          group.setAttribute('class', 'glyph');
          
          let gpath = document.createElementNS(svg_ns, 'path');
          gpath.setAttribute('class', 'gpath');
          gpath.setAttribute('d', d);
          
          let desc = document.createElementNS(svg_ns, 'text');
          //desc.style['transform'] = `translate(${0}px, ${100}px)`;
          desc.setAttribute('class', 'desc');
          desc.setAttribute('text-anchor', 'middle');
          desc.setAttribute('alignment-baseline', 'middle');
          desc.textContent = file.split('.')[0];
          desc.setAttribute('x', 0);
          desc.setAttribute('y', 0);
          
          
          let x = Math.random() * innerWidth;
          let y = Math.random() * innerHeight;
          group.style.transform = `translate(${x}px, ${y}px)`;
          
          group.appendChild(desc);
          group.appendChild(gpath);
          el_svg.appendChild(group);
          
          let bbox = gpath.getBBox();
          gpath.style.transform = `scale(0.5, 0.5) translate(${-bbox.width*0.5}px, ${-bbox.height*0.5}px)`;
        }
      }
    });  
  }
  
  let touch = {
    down: false,
    px: 0,
    py: 0,
    dx: 0,
    dy: 0,
    x: 0,
    y: 0,
    glyph: null,
  };
  
  function touchstart(x, y) {
    touch.down = true;
    touch.px = touch.x;
    touch.py = touch.y;
    touch.x = x;
    touch.y = y;
  }
  
  function touchend() {
    touch.down = false;
    touch.px = touch.x;
    touch.py = touch.y;
    touch.glyph = null;
  }
  
  function touchmove(x, y) {
    touch.px = touch.x;
    touch.py = touch.y;
    touch.x = x;
    touch.y = y;
    
    if(touch.down) {
      touch.glyph.style.transform = `translate(${touch.x - touch.dx}px, ${touch.y - touch.dy}px)`;
    }
  }
  
  el_svg.onmousedown = function(e) {
    if(e.target.getAttribute('class') == 'gpath' && touch.glyph == null) {
      console.log(e.target);
      touch.glyph = e.target.parentElement;
      touchstart(e.pageX, e.pageY - rect_ui.height);
    }
  };
  
  el_svg.onmouseup = function(e) {
    touchend();
  };
  
  el_svg.onmousemove = function(e) {
    touchmove(e.pageX, e.pageY - rect_ui.height);
  };
  
  el_svg.ontouchstart = function(e) {
    if(e.target.getAttribute('class') == 'gpath' && touch.glyph == null) {
      touch.glyph = e.target.parentElement;
      if(e.touches.length > 0) {
        let rect = e.target.getBoundingClientRect();
        touch.dx = e.touches[0].pageX - (rect.left + rect.right) * 0.5;
        touch.dy = e.touches[0].pageY - (rect.top + rect.bottom) * 0.5;
        touchstart(e.touches[0].pageX, e.touches[0].pageY - rect_ui.height);
      }
    }
  };
  
  el_svg.ontouchend = function(e) {
    touchend();
  };
  
  el_svg.ontouchmove = function(e) {
    if(e.touches.length > 0) {
      touchmove(e.touches[0].pageX, e.touches[0].pageY - rect_ui.height);
      e.preventDefault();
    }
  };
  
  checkbox_show_desc.oninput = function() {
    if(checkbox_show_desc.checked) {
      //style_desc['transform'] = 'translate(0px, 100px) scale(1, 1)';
      let descs = document.querySelectorAll('.desc');
      for(let desc of descs) {
        desc.setAttribute('opacity', 1);
      }
      document.querySelector('#ui').style.backgroundColor = 'yellow';
    }
    else {
      //style_desc['transform'] = 'translate(0px, 100px) scale(0, 0)';
      let descs = document.querySelectorAll('.desc');
      for(let desc of descs) {
        desc.setAttribute('opacity', 0);
      }
      document.querySelector('#ui').style.backgroundColor = 'cyan';
    } 
  };
  
  function layout () {
    rect_ui = el_ui.getBoundingClientRect();
    el_svg.setAttribute('width', innerWidth);
    el_svg.setAttribute('height', innerHeight - 2 - rect_ui.height);
    el_svg.style.left = '0px';
    el_svg.style.top = rect_ui.height + 'px';
  }
  
  window.onresize = function() {
    layout();
  };
  
  window.onload = function() {
    layout();
  };
</script>