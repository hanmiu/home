<!doctype html>
<meta charset="utf-8">
<title>몸문자</title>
<style title="main">
  @import url('https://fonts.googleapis.com/css?family=Black+Han+Sans');
  @import url('https://fonts.googleapis.com/css?family=Do+Hyeon');
  
  html {
    overflow: hidden; 
  }
  
  body {
    margin: 0;
    user-select: none;
    overflow: hidden;
  }
  
  .glyph {
  }
  
  .desc {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 30px;
    /*
    fill: black;
    transition: transform 0.2s;
    */
    opacity: 0;
    transition: opacity 0.2s;
    transform: translate(0px, 100px);
  }
  
  .gpath {
    fill: blue;
    cursor: pointer;
  }
  
  #ui {
    position: fixed;
    left: 0px;
    top: 0px;
    width: 100vw;
    height: 10vh;
    background-color: #30f09f;
  }
  
  #svg {
    position: fixed;
  }
  
  #info {
    position: fixed;
    right: 0px;
    bottom: 0px;
    font-size: 2em;
  }
  
  #pane {
    position: fixed;
    left: 0px;
    top: 0px;
    width: 100px;
    height: 100vh;
    background-color: aquamarine;
    overflow-x: hidden;
    overflow-y: scroll;
  }
  
  .item {
    width: 80px;
    height: 80px;
    border-radius: 40px;
    background-color: blueviolet;
  }
  
  input {
    transform-origin: left top;
    transform: scale(2, 2);
  }
  
  #message {
    position: fixed;
    width: 100vw;
    height: 100vh;
    left: 0px;
    top: 0px;
    font-size: 5vw;
    text-align: center;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    line-height: 33vh;
  }
</style>
<body>
  <svg id="svg"></svg>
  <div id="ui">
    <input type="checkbox" id="show-desc">
    <button id="test">test</button>
  </div>
  <div id="info">0</div>
  <div id="pane"></div>
  <div id="message">
    <div id="inner">아직 만드는 중,<br>늦어져서 미안해요!<br>12월 25일 아침까지 기다려 주세요.</div>
  </div>
</body>
<script>
  let svg_ns = 'http://www.w3.org/2000/svg';
  let el_svg = document.querySelector('#svg');
  let el_ui = document.querySelector('#ui');
  let el_pane = document.querySelector('#pane');
  let rect_svg = el_svg.getBoundingClientRect();
  let rect_ui = el_ui.getBoundingClientRect();
  
  let checkbox_show_desc = document.querySelector('#show-desc');
  
  let main_stylesheet = [].slice.call(document.styleSheets).filter(x => x.title == 'main')[0];
  
  function get_style_rule(selectorText) {
    return [].slice.call(main_stylesheet.cssRules).filter(x => x.selectorText == selectorText)[0];
  }
  
  let style_desc = get_style_rule('.desc').style;
  
  let files = [
    '새.svg',
    '모른다.svg',
    '풀 위에 토끼.svg',
  ];
  
  let dom_parser = new DOMParser();
  
  for(let file of files) {
    fetch('./data/mmj/' + file)
    .then(response => response.text())
    .then(text => {
      let xml = dom_parser.parseFromString(text, 'text/xml');
      let paths = xml.querySelectorAll('path');
      for(let i = 0; i < paths.length; i++) {
        let d = paths[i].getAttribute('d');
        if(d.trim().length > 0) {
          let group = document.createElementNS(svg_ns, 'g');
          group.setAttribute('class', 'glyph');
          
          let gpath = document.createElementNS(svg_ns, 'path');
          gpath.setAttribute('class', 'gpath');
          gpath.setAttribute('d', d);
          
          let desc = document.createElementNS(svg_ns, 'text');
          //desc.style['transform'] = `translate(${0}px, ${100}px)`;
          desc.setAttribute('class', 'desc');
          desc.setAttribute('text-anchor', 'middle');
          desc.setAttribute('alignment-baseline', 'middle');
          desc.textContent = file.split('.')[0];
          desc.setAttribute('x', 0);
          desc.setAttribute('y', 0);
          
          
          let x = Math.random() * innerWidth;
          let y = Math.random() * innerHeight;
          group.style.transform = `translate(${x}px, ${y}px)`;
          
          group.appendChild(desc);
          group.appendChild(gpath);
          el_svg.appendChild(group);
          
          let bbox = gpath.getBBox();
          gpath.style.transform = `scale(0.5, 0.5) translate(${-bbox.width*0.5}px, ${-bbox.height*0.5}px)`;
        }
      }
    });  
  }
  
  let touch = {
    down: false,
    px: 0,
    py: 0,
    dx: 0,
    dy: 0,
    x: 0,
    y: 0,
    glyph: null,
  };
  
  function touchstart(target, x, y) {
    touch.glyph = target.parentElement;
    let rect = target.getBoundingClientRect();
    touch.dx = x - (rect.left + rect.right) * 0.5;
    touch.dy = y - (rect.top + rect.bottom) * 0.5 + rect_svg.top;
    
    touch.down = true;
    touch.px = touch.x;
    touch.py = touch.y;
    touch.x = x;
    touch.y = y;
  }
  
  function touchend() {
    touch.down = false;
    touch.px = touch.x;
    touch.py = touch.y;
    touch.glyph = null;
  }
  
  function touchmove(x, y) {
    touch.px = touch.x;
    touch.py = touch.y;
    touch.x = x;
    touch.y = y;
    
    if(touch.down) {
      touch.glyph.style.transform = `translate(${touch.x - touch.dx}px, ${touch.y - touch.dy}px)`;
    }
  }
  
  el_svg.onmousedown = function(e) {
    if(e.target.getAttribute('class') == 'gpath' && touch.glyph == null) {
      touchstart(e.target, e.pageX, e.pageY - rect_svg.top);
    }
  };
  
  el_svg.onmouseup = function(e) {
    touchend();
  };
  
  el_svg.onmousemove = function(e) {
    touchmove(e.pageX, e.pageY - rect_svg.top);
  };
  
  el_svg.ontouchstart = function(e) {
    if(e.target.getAttribute('class') == 'gpath' && touch.glyph == null) {
      if(e.touches.length > 0) {
        touchstart(e.target, e.touches[0].pageX, e.touches[0].pageY - rect_svg.top);
      }
    }
    e.preventDefault();
  };
  
  el_svg.ontouchend = function(e) {
    touchend();
    e.preventDefault();
  };
  
  el_svg.ontouchmove = function(e) {
    if(e.touches.length > 0) {
      touchmove(e.touches[0].pageX, e.touches[0].pageY - rect_svg.top);
      e.preventDefault();
    }
  };
  
  checkbox_show_desc.oninput = function() {
    if(checkbox_show_desc.checked) {
      //style_desc['transform'] = 'translate(0px, 100px) scale(1, 1)';
      let descs = document.querySelectorAll('.desc');
      for(let desc of descs) {
        desc.setAttribute('opacity', 1);
      }
      document.querySelector('#ui').style.backgroundColor = 'yellow';
    }
    else {
      //style_desc['transform'] = 'translate(0px, 100px) scale(0, 0)';
      let descs = document.querySelectorAll('.desc');
      for(let desc of descs) {
        desc.setAttribute('opacity', 0);
      }
      document.querySelector('#ui').style.backgroundColor = 'cyan';
    } 
  };
  
  function layout () {
    document.querySelector('#info').textContent = window.scrollY;
    rect_ui = el_ui.getBoundingClientRect();
    el_svg.setAttribute('width', innerWidth);
    el_svg.setAttribute('height', innerHeight + window.scrollY);
    el_svg.style.left = '0px';
    el_svg.style.top = rect_ui.height + 'px';
    rect_svg = el_svg.getBoundingClientRect();
  }
  
  window.onresize = function() {
    setTimeout(layout, 500);
  };
  
  window.onload = function() {
    setTimeout(layout, 500);
    
    for(let i = 0; i < 100; i++) {
      let el = document.createElement('div');
      el.className = 'item';
      el.textContent = i;
      el_pane.appendChild(el);
    }
  };
  
  document.querySelector('#test').onclick = function() {
    style_desc['opacity'] = 1;
  }
</script>